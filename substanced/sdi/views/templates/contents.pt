<div metal:use-macro="sdi_h.macros()['master']">

  <div tal:omit-tag="" metal:fill-slot="head-more">
    <!-- slickgrid -->
    <script src="${request.static_url('substanced.sdi:static/js/slickgrid.upstream.js')}" type="text/javascript"></script>
    <script src="${request.static_url('substanced.sdi:static/js/slickgrid-config.js')}" type="text/javascript"></script>
    <link href="${request.static_url('substanced.sdi:static/css/slick.grid.upstream.css')}" rel="stylesheet" />
    <link href="${request.static_url('substanced.sdi:static/css/sdi_slickgrid.css')}" rel="stylesheet" />
  </div>

  <div metal:fill-slot="main">
    <div class="container-fluid">

    <h2 tal:condition="not items">No items</h2>

    <div tal:condition="items">
    <div id="sdi-contents-table-sg" class="slickgrid-wrapper"></div>
    <script type="text/javascript">
        jQuery(function ($) {
            $('#sdi-contents-table-sg').slickgrid(${slickgrid_wrapper_options});
        });
    </script>

    <div class="clearfix">
    </div>

    <form action="@@contents" method="POST">
      <fieldset>
      <input type="hidden" name="csrf_token" 
             value="${request.session.get_csrf_token()}"/>

      <div class="form-actions btn-toolbar">

        <div tal:repeat="group buttons"
           class="${group['type']=='group' and 'btn-group' or 'btn-single'}">
            <button tal:repeat="button group['buttons']"
                    id="${button['id']}"
                    name="${button['name']}"
                    class="btn ${button['class']}"
                    value="${button['value']}"
                    type="submit"
                    >
            ${button['text']}
            </button>
        </div>
        <input type="hidden" name="item-modify" value="" />
        <script type="text/javascript">
            jQuery(function ($) {
                var $form =  $('form[action="@@contents"]');
                $form.find('button').click(function (evt) {
                    var $hiddenInput =  $form.find('input[name="item-modify"]');
                    var $gridWrapper = $('#sdi-contents-table-sg').data('slickgrid');
                    var grid = $gridWrapper.grid;
                    var data = grid.getData();
                    var selectedIdx = grid.getSelectedRows();
                    if (selectedIdx.length > 100) {
                        // XXX XXX XXX This is a problem. We need to limit
                        // the selection size, because of cookieval is limited
                        // in 4096 bytes. An additional problem is we don't know
                        // how to limit the selection size to assure that the submit
                        // won't break, because the cookie size depends on the lengths
                        // of the names, too, and not only on the size of the selection.
                        // TODO this must be solved somehow!
                        alert('We currently limit the selection size in maximum 100 items.\n' +
                              'Please select less than 100 items!');
                        return false;
                    }
                    var selectedIds = $.map(selectedIdx, function (value, index) {
                        var row = data.getItemByIdx(value);
                        return row.id;
                    })
                    // I think it is better to submit the list as a
                    // concatenated value, instead of adding several inputs to the dom.
                    $hiddenInput.attr('value', selectedIds.join(','));
                });
            });
        </script>



        <tal:block tal:condition="'tocopy' not in request.session and 'tomove' not in request.session">
        <div class="btn-group pull-right" tal:condition="addables">
          <a class="btn btn-primary" 
             href="${request.mgmt_path(context, '@@add')}"><i 
             class="icon-plus-sign icon-white"></i> Add</a>
          <a class="btn btn-primary dropdown-toggle" 
              data-toggle="dropdown" href="#"><span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li tal:repeat="addable addables">
               <a href="${addable['url']}"><i 
              class="${addable['icon']}"></i> ${addable['type_name']}</a></li>
          </ul>
        </div>
        </tal:block>

      </fieldset>
    </form>

  </div>
  </div>
  </div>

</div>
